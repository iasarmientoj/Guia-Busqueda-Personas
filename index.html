<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía de Búsqueda - MinJusticia</title>
    <!-- Fuentes y Estilos -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Agregamos Marked para procesar el Markdown de las acciones -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'gov-blue': '#3366CC', 'gov-dark-blue': '#004884', 'gov-bg': '#F7F9FC' },
                    fontFamily: { sans: ['Nunito Sans', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito Sans', sans-serif; background-color: #F2F2F2; color: #333; transition: background-color 0.3s, color 0.3s; }
        
        /* Botones Estilo GOV.CO */
        .btn-gov {
            background-color: white; color: #3366CC; border: 2px solid #3366CC; border-radius: 25px; 
            padding: 12px 24px; font-weight: 700; transition: all 0.2s; width: 100%; text-align: left; 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
            cursor: pointer;
        }
        .btn-gov:hover, .btn-gov.selected { background-color: #3366CC; color: white; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(51, 102, 204, 0.2); }
        
        /* Checkbox Cards */
        .checkbox-card { 
            cursor: pointer; border: 1px solid #d1d5db; background: white; transition: all 0.2s; 
            border-radius: 8px; padding: 16px; display: flex; align-items: center;
        }
        .checkbox-card:hover { border-color: #3366CC; background-color: #F8FBFF; }
        .checkbox-card.selected { border-color: #3366CC; background-color: #EFF6FF; ring: 1px solid #3366CC; }
        
        .checkbox-mark { 
            width: 20px; height: 20px; flex-shrink: 0; 
            border: 2px solid #9CA3AF; border-radius: 4px; margin-right: 12px; 
            display: flex; align-items: center; justify-content: center; background: white; 
        }
        .checkbox-card.selected .checkbox-mark { border-color: #3366CC; background-color: #3366CC; }
        
        /* Acordeones */
        details > summary { list-style: none; cursor: pointer; transition: all 0.3s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { background-color: #EFF6FF; border-bottom: 1px solid #E5E7EB; }
        .chevron { transition: transform 0.3s; }
        details[open] .chevron { transform: rotate(180deg); }
        
        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 50; display: flex; justify-content: center; align-items: center; flex-direction: column; }

        /* Tabs Styles (Botones) */
        .tab-btn {
            padding: 10px 20px;
            font-weight: 700;
            color: #3366CC;
            border: 1px solid #3366CC;
            border-radius: 20px;
            background-color: white;
            transition: all 0.3s;
            text-align: center;
            flex-grow: 1;
            min-width: 140px;
        }
        .tab-btn.active {
            color: white;
            background-color: #3366CC;
            border-color: #3366CC;
            box-shadow: 0 4px 6px rgba(51, 102, 204, 0.2);
        }
        .tab-btn:hover:not(.active) {
            background-color: #EFF6FF;
            transform: translateY(-1px);
        }

        /* --- ESTILOS MARKDOWN DENTRO DE DETALLES --- */
        .md-content h1 { font-size: 1.5rem; font-weight: 800; color: #004884; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 1px solid #E5E7EB; padding-bottom: 0.25rem; }
        .md-content h2 { font-size: 1.25rem; font-weight: 700; color: #3366CC; margin-top: 1.25rem; margin-bottom: 0.5rem; }
        .md-content h3 { font-size: 1.1rem; font-weight: 600; color: #374151; margin-top: 1rem; margin-bottom: 0.5rem; }
        .md-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .md-content ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .md-content p { margin-bottom: 1em; line-height: 1.6; }
        .md-content a { color: #3366CC; text-decoration: underline; }
        .md-content strong { font-weight: 700; color: #004884; }
        .md-content blockquote { border-left: 4px solid #3366CC; padding-left: 1rem; color: #4B5563; background-color: #F9FAFB; padding: 0.5rem 1rem; margin-bottom: 1rem; border-radius: 0 4px 4px 0; }

        /* --- ACCESIBILIDAD --- */
        .a11y-menu {
            position: fixed; right: 0; top: 50%; transform: translateY(-50%); z-index: 60;
            display: flex; flex-direction: column; gap: 2px;
            align-items: flex-end; /* FIX: Alinea los items a la derecha para que crezcan hacia la izquierda */
        }
        .a11y-btn {
            background-color: #004884; color: white; border: none; padding: 10px; width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: flex-start; 
            cursor: pointer;
            border-top-left-radius: 4px; border-bottom-left-radius: 4px;
            transition: width 0.3s ease, background-color 0.2s; overflow: hidden; white-space: nowrap;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.2);
        }
        .a11y-btn img { filter: brightness(0) invert(1); }
        .a11y-btn:hover { width: 140px; background-color: #3366CC; }
        .a11y-label { opacity: 0; margin-left: 10px; font-size: 14px; font-weight: 600; transition: opacity 0.2s; }
        .a11y-btn:hover .a11y-label { opacity: 1; }

        /* Alto Contraste */
        body.high-contrast { background-color: #000 !important; color: #FFF !important; }
        body.high-contrast header { background-color: #000 !important; border-bottom: 2px solid #FFFF00; }
        body.high-contrast .bg-white { background-color: #000 !important; color: #FFF !important; border: 1px solid #FFF !important; }
        body.high-contrast .bg-blue-50, body.high-contrast .bg-gov-bg, body.high-contrast .bg-gray-100 { background-color: #1a1a1a !important; color: #FFF !important; border: 1px solid #888; }
        body.high-contrast .text-gov-blue, body.high-contrast .text-gov-dark-blue, body.high-contrast .md-content strong, body.high-contrast .md-content a, body.high-contrast .md-content h1, body.high-contrast .md-content h2, body.high-contrast .md-content h3 { color: #FFFF00 !important; }
        body.high-contrast .text-gray-600, body.high-contrast .text-gray-700, body.high-contrast .text-gray-500, body.high-contrast .text-gray-800 { color: #DDD !important; }
        body.high-contrast .btn-gov { background-color: #000 !important; color: #FFFF00 !important; border-color: #FFFF00 !important; }
        body.high-contrast .btn-gov:hover, body.high-contrast .btn-gov.selected { background-color: #FFFF00 !important; color: #000 !important; }
        body.high-contrast .checkbox-card { background-color: #000 !important; border-color: #FFF !important; }
        body.high-contrast .checkbox-card.selected { border: 2px solid #FFFF00 !important; }
        body.high-contrast .checkbox-mark { background-color: #000 !important; border-color: #FFFF00 !important; }
        body.high-contrast .checkbox-card.selected .checkbox-mark { background-color: #FFFF00 !important; }
        body.high-contrast .checkbox-card.selected .checkbox-mark svg { color: #000 !important; }
        body.high-contrast .tab-btn { color: #FFFF00 !important; border-color: #FFFF00 !important; background-color: #000 !important; }
        body.high-contrast .tab-btn.active { color: #000 !important; background-color: #FFFF00 !important; }
        body.high-contrast footer { background-color: #111 !important; border-top: 1px solid #FFFF00; }
        body.high-contrast img { filter: grayscale(100%) contrast(120%); }

        /* FIXES ALTO CONTRASTE ESPECÍFICOS */
        body.high-contrast #loader { background-color: #000 !important; }
        body.high-contrast select, body.high-contrast input, body.high-contrast textarea { background-color: #000 !important; color: #FFFF00 !important; border: 1px solid #FFFF00 !important; }
        body.high-contrast .bg-blue-100 { background-color: #000 !important; color: #FFFF00 !important; border: 1px solid #FFFF00 !important; }
        body.high-contrast details[open] > summary { background-color: #1a1a1a !important; border-bottom: 1px solid #FFFF00 !important; }
        body.high-contrast .bg-gray-200 { background-color: #000 !important; color: #FFFF00 !important; border: 1px solid #FFFF00 !important; }
        body.high-contrast details .p-5 { background-color: #000 !important; color: #FFF !important; }
        /* FIX BLOCKQUOTE ALTO CONTRASTE */
        body.high-contrast .md-content blockquote { background-color: #000 !important; color: #FFF !important; border-left: 4px solid #FFFF00 !important; border: 1px solid #FFFF00; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Menú de Accesibilidad -->
    <div class="a11y-menu">
        <button onclick="toggleContrast()" class="a11y-btn" aria-label="Alto Contraste">
            <img src="icons8-contrast-50.png" class="w-6 h-6 flex-shrink-0" alt="Contraste">
            <span class="a11y-label">Contraste</span>
        </button>
        <button onclick="changeFontSize(-10)" class="a11y-btn" aria-label="Reducir Letra">
            <img src="icons8-decrease-font-64.png" class="w-6 h-6 flex-shrink-0" alt="Reducir">
            <span class="a11y-label">Reducir Letra</span>
        </button>
        <button onclick="changeFontSize(10)" class="a11y-btn" aria-label="Aumentar Letra">
            <img src="icons8-increase-font-64.png" class="w-6 h-6 flex-shrink-0" alt="Aumentar">
            <span class="a11y-label">Aumentar Letra</span>
        </button>
    </div>

    <!-- Pantalla de Carga -->
    <div id="loader">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-gov-blue mb-4"></div>
        <p class="text-gov-blue font-bold text-lg">Cargando Guía Interactiva...</p>
        <p id="loaderStatus" class="text-sm text-gray-500 mt-2 font-mono">Conectando a Google Sheets...</p>
        <div id="errorMsg" class="hidden mt-4 text-center max-w-md p-4 bg-red-50 border border-red-200 rounded text-red-700 text-sm"></div>
    </div>

    <!-- Header -->
    <header class="bg-gov-blue text-white py-4 shadow-md sticky top-0 z-40 transition-colors duration-300">
        <div class="container mx-auto px-4 flex items-center">
            <a href="https://www.gov.co/" target="_blank" class="mr-4 border-r border-blue-400 pr-4 flex items-center hover:opacity-90 transition-opacity">
                <img src="logoGovCO.png" alt="GOV.CO" class="h-8 md:h-9 w-auto">
            </a>
            <div class="text-sm font-light leading-tight">Guía de Búsqueda de Personas<br><span class="font-bold">Ministerio de Justicia y del Derecho</span></div>
        </div>
    </header>

    <!-- Main -->
    <main class="container mx-auto px-4 py-8 max-w-4xl flex-grow">
        <!-- Barra de Progreso -->
        <div id="progressContainer" class="mb-8 max-w-3xl mx-auto transition-opacity duration-300">
            <div class="flex justify-between text-xs text-gray-500 mb-2 font-bold uppercase tracking-wider">
                <span>Perfil</span><span>Tiempo</span><span>Lugar</span><span>Indicios</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-gov-blue transition-all duration-500 ease-out" style="width: 10%"></div>
            </div>
        </div>

        <!-- Contenedor de Vistas -->
        <div id="viewContainer" class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 md:p-8 min-h-[400px] transition-colors duration-300">
            <!-- El contenido dinámico va aquí -->
        </div>

        <!-- Botones Navegación -->
        <div class="mt-8 flex justify-between max-w-3xl mx-auto" id="navButtons">
            <button onclick="goBack()" id="backBtn" class="text-gov-blue font-bold hover:underline flex items-center px-4 py-2 invisible">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Atrás
            </button>
            <button id="nextBtn" onclick="goNext()" class="bg-gov-blue text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-gov-dark-blue hidden flex items-center transition-all">
                Continuar <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gov-blue py-4 mt-auto transition-colors duration-300">
        <div class="container mx-auto px-4">
            <!-- CAMBIO: Se eliminó border-t y border-blue-400/30 para limpiar el footer -->
            <div class="pt-4 flex items-center">
                <img src="logoGovCO.png" alt="GOV.CO" class="h-6 w-auto opacity-90 brightness-0 invert">
            </div>
        </div>
    </footer>

    <script>
        // --- LOGICA DE ACCESIBILIDAD ---
        let currentFontSize = 100;

        function toggleContrast() { document.body.classList.toggle('high-contrast'); }
        function changeFontSize(amount) {
            currentFontSize += amount;
            if (currentFontSize < 80) currentFontSize = 80;
            if (currentFontSize > 150) currentFontSize = 150;
            document.documentElement.style.fontSize = currentFontSize + '%';
        }
        function toggleHelp(helpId) {
            const helpEl = document.getElementById(helpId);
            if (helpEl) helpEl.classList.toggle('hidden');
        }
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('active');
        }

        // --- 1. CONFIGURACIÓN DE DATOS ---
        const SHEETS_CONFIG = {
            ACCIONES: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlcYT96Ei7UKp-CRqiq5Q2Yq8sAIJMHaEA-DaN8-EXdoZz8RRZmokpHqcXrTDfYdcvWKEO2j3GO6c/pub?gid=812842567&single=true&output=csv',
            CONTACTOS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlcYT96Ei7UKp-CRqiq5Q2Yq8sAIJMHaEA-DaN8-EXdoZz8RRZmokpHqcXrTDfYdcvWKEO2j3GO6c/pub?gid=871607364&single=true&output=csv'
        };

        // Mapa de rutas maestras según opción de P1
        const ROUTES_MAP = {
            '4.1': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlcYT96Ei7UKp-CRqiq5Q2Yq8sAIJMHaEA-DaN8-EXdoZz8RRZmokpHqcXrTDfYdcvWKEO2j3GO6c/pub?gid=545298463&single=true&output=csv',
            '4.2': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlcYT96Ei7UKp-CRqiq5Q2Yq8sAIJMHaEA-DaN8-EXdoZz8RRZmokpHqcXrTDfYdcvWKEO2j3GO6c/pub?gid=1342244385&single=true&output=csv',
            '4.3': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlcYT96Ei7UKp-CRqiq5Q2Yq8sAIJMHaEA-DaN8-EXdoZz8RRZmokpHqcXrTDfYdcvWKEO2j3GO6c/pub?gid=399030951&single=true&output=csv',
            '4.4': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlcYT96Ei7UKp-CRqiq5Q2Yq8sAIJMHaEA-DaN8-EXdoZz8RRZmokpHqcXrTDfYdcvWKEO2j3GO6c/pub?gid=718152538&single=true&output=csv',
            '4.5': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlcYT96Ei7UKp-CRqiq5Q2Yq8sAIJMHaEA-DaN8-EXdoZz8RRZmokpHqcXrTDfYdcvWKEO2j3GO6c/pub?gid=428871968&single=true&output=csv',
            '4.6': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlcYT96Ei7UKp-CRqiq5Q2Yq8sAIJMHaEA-DaN8-EXdoZz8RRZmokpHqcXrTDfYdcvWKEO2j3GO6c/pub?gid=1764372827&single=true&output=csv'
        };

        // Bases de Datos en Memoria
        let DB_ACCIONES = []; 
        let DB_CONTACTOS = []; 
        let CURRENT_ROUTE_DATA = []; // Datos de la ruta maestra seleccionada

        // --- 2. ESTADO DE LA APP ---
        const state = {
            currentStep: 'intro',
            history: [],
            answers: {
                p1: null, p1_sub: null, 
                p2: null, p2_sub: null, p2_date_month: null, p2_date_year: null,
                p3_type: null, p3_detail: null, p3_sub_detail: null, p3_characteristics: [], 
                p4_profile: [],
                narrative: '' // Guardamos la narrativa aquí
            }
        };

        // CONSTANTES GEOGRÁFICAS INICIALES (Se sobrescribirán con datos reales)
        let COUNTRIES_LIST = ['Colombia'];
        let CITIES_LIST = ['Bogotá D.C.'];
        let MUNICIPALITIES_LIST = ['Bogotá D.C.'];
        
        // --- 3. DEFINICIÓN DE PASOS (UI) ---
        const steps = {
            // PASO 0: INTRODUCCIÓN
            'intro': {
                progress: '0%',
                title: 'Bienvenido',
                type: 'intro',
                description: 'Esta es una herramienta de orientación para la búsqueda de personas dadas por desaparecidas. Le guiaremos paso a paso para identificar la ruta de acción más efectiva según su caso.',
                disclaimer: 'Su privacidad es fundamental. Esta guía es anónima: no almacenamos, registramos ni compartimos ningún dato personal que ingrese durante la consulta.',
                btnLabel: 'Comenzar Consulta'
            },
            // PASO 1: PERFIL (P4)
            'p4': { 
                progress: '20%', 
                title: '¿Quién es la persona desaparecida?', 
                description: 'Seleccione todas las condiciones que apliquen. Esto define la prioridad de la búsqueda.',
                type: 'multi-choice', 
                options: [
                    { id: '1.1', label: 'Es un/a niño/a o adolescente', help: 'Menor de 18 años al momento de desaparecer.' },
                    { id: '1.2', label: 'Es una persona con un rol público o de alto riesgo', help: 'Líder, defensor/a, periodista, sindicalista, político.' },
                    { id: '1.3', label: 'Es o fue miembro de la Fuerza Pública', help: 'Ejército, Policía, Armada, Fuerza Aérea, etc.' },
                    { id: '1.4', label: 'Es o fue integrante de un grupo armado ilegal', help: 'Guerrilla, AUC, BACRIM, GAO, etc.' },
                    { id: '1.5', label: 'Es una persona que requiere cuidado o apoyo especial', help: 'Adulto mayor, condiciones de salud mental, discapacidad.' },
                    { id: '1.6', label: 'Es migrante o de nacionalidad extranjera' },
                    { id: '1.7', label: 'Es una mujer y se teme violencia de género', help: 'Antecedentes de violencia intrafamiliar, exparejas agresivas, etc.' },
                    { id: '1.8', label: 'Pertenece a comunidad indígena o NARP', help: 'Comunidades Negras, Afrocolombianas, Raizales y Palenqueras.' },
                    { id: '1.9', label: 'Se identifica como persona LGBTIQ+' },
                    { id: '1.10', label: 'Desaparecieron dos o más personas juntas', help: 'Ej: madre e hijo, hermanos, familia entera.' },
                    { id: '1.11', label: 'Ninguna de las anteriores' }
                ]
            },
            // PASO 2: TIEMPO (P2)
            'p2': { 
                progress: '40%', 
                title: '¿Hace cuánto tiempo ocurrió?', 
                description: 'Esto determina si la búsqueda es operativa (urgente) o investigativa (histórica).',
                type: 'single-choice', 
                options: [
                    { id: '2.1', label: 'Ocurrió hace poco (horas, días o semanas)' },
                    { id: '2.2', label: 'Ocurrió hace más de un año' }
                ]
            },
            // PASO 2.1: FECHA DETALLADA (Solo si es > 1 año)
            'p2_date': {
                progress: '45%',
                title: 'Fecha aproximada de los hechos',
                description: 'Por favor indique el mes y año aproximado en que ocurrió la desaparición.',
                type: 'date-year-picker'
            },
            // PASO 3: LUGAR (P3)
            'p3_type': { 
                progress: '60%', 
                title: '¿Dónde ocurrió o fue vista por última vez?', 
                type: 'single-choice', 
                options: [
                    { id: '3.1', label: 'Capital o ciudad principal' },
                    { id: '3.2', label: 'Municipio pequeño o zona rural' },
                    { id: '3.3', label: 'En otro país' }
                ]
            },
            'p3.1': { progress: '65%', title: 'Seleccione la ciudad', type: 'dropdown', data: CITIES_LIST },
            
            // CAMBIO: NUEVO TIPO PARA MUNICIPIO + CIUDAD
            'p3.2': { 
                progress: '65%', 
                title: 'Ubicación en Municipio', 
                type: 'municipality-city', 
                municipalityData: ['Otro'], // Según instrucciones
                cityData: CITIES_LIST, // Para sugerir la ciudad cercana
                description: 'Seleccione el municipio y la ciudad principal más cercana para ubicar las entidades de apoyo.' 
            },
            
            'p3.3': { progress: '65%', title: 'Seleccione el país', type: 'dropdown', data: ['España', 'Estados Unidos', 'México', 'Ecuador', 'Chile', 'Otro'] },
            
            'p3.4': { 
                progress: '75%', 
                title: 'Características del lugar', 
                description: 'Marque si el lugar tiene alguna condición especial.',
                type: 'multi-choice', 
                options: [
                    { id: '3.4.1', label: 'En el agua o cerca de ella', help: 'Mar, río, costa, puerto, represa' },
                    { id: '3.4.2', label: 'Cerca de una frontera con otro país', help: 'Límite con Venezuela, Ecuador, Panamá, etc.' },
                    { id: '3.4.3', label: 'En un resguardo o territorio indígena', help: 'Territorio de un cabildo, comunidad o pueblo indígena' },
                    { id: '3.4.4', label: 'En un Parque Nacional o reserva natural', help: 'Parque Tayrona, El Cocuy, reserva forestal, etc.' },
                    { id: '3.4.5', label: 'En una montaña, selva o bosque (fuera de un parque)', help: 'Zona rural de difícil acceso, senderismo' },
                    { id: '3.4.6', label: 'En una zona de minería, petróleo u otra explotación de recursos', help: 'Cerca de una mina, un campo petrolero, zona de tala' },
                    { id: '3.4.7', label: 'En una zona de conflicto armado o con grupos ilegales', help: 'Presencia de guerrilla, paramilitares, bandas criminales' },
                    { id: '3.4.8', label: 'Dentro o cerca de una base militar, de policía o entidad del Estado', help: 'Batallón, estación de policía, CAI, instalaciones oficiales' },
                    { id: '3.4.9', label: 'Dentro o cerca de un cementerio o morgue', help: 'Fosas comunes, osarios, depósitos de cuerpos no identificados, fosa clandestina o enterramiento ilegal' },
                    { id: '3.4.10', label: 'Ninguna de estas' }
                ]
            },
            // PASO 4: CONTEXTO / INDICIOS (P1 - Flujo Inverso)
            'p1': { 
                progress: '90%', 
                title: '¿Tiene alguna sospecha de lo que ocurrió?', 
                description: 'Esta información nos ayuda a dirigirlo a la entidad especializada.',
                type: 'single-choice', 
                options: [
                    { id: '4.1', label: 'En un contexto de conflicto armado o violencia política', help: 'Sospecha de Guerrilla, Paramilitares, "Falsos Positivos", Grupos Armados, violencia en protestas, muerto en combate.' },
                    { id: '4.2', label: 'A causa de un crimen o acto de delincuencia común', help: 'Sospecha de secuestro, extorsión, robo, "gota a gota", bandas, trata de personas, violencia de pareja.' },
                    { id: '4.3', label: 'Se perdió o se ausentó (sin violencia aparente)', help: 'Salió de casa y no regresó, puede estar desorientado/a, se fue por voluntad propia, se perdió en un lugar concurrido.' },
                    { id: '4.4', label: 'Durante un accidente o desastre natural', help: 'Desapareció en un río, en el mar, en una montaña (senderismo) o durante una avalancha, derrumbe, etc.' },
                    { id: '4.5', label: 'En un contexto de migración o estando en el exterior', help: 'Estaba en una ruta migratoria (ej. Darién) o vivía/viajaba en otro país.' },
                    { id: '4.6', label: 'No tengo sospechas claras de lo que pudo pasar', help: 'Simplemente no he vuelto a saber de él/ella y no tengo pistas para empezar.' }
                ]
            },
            // SUB-PANTALLA CONFLICTO (4.1)
            'p1_conflict': { 
                progress: '95%', 
                title: 'Detalles del Conflicto', 
                description: 'Especifique la situación para activar rutas de búsqueda humanitaria.',
                type: 'single-choice', 
                options: [
                    { id: '4.1.1', label: 'Involucra grupos armados al margen de la ley', help: 'Guerrilla, BACRIM, disidencias, grupos multicrimen.' },
                    { id: '4.1.2', label: 'Sospecha de participación de agentes del Estado', help: 'Policía, Ejército o Servidores Públicos.' },
                    { id: '4.1.3', label: 'Relacionado con reclutamiento forzado de menores' },
                    { id: '4.1.4', label: 'Muerto en combate o acto de hostilidades' },
                    { id: '4.1.5', label: 'Otra situación / No sé específicamente' }
                ]
            },
            // SUB-PANTALLA CRIMEN (4.2)
            'p1_crime': { 
                progress: '95%', 
                title: 'Especifique el tipo de crimen', 
                alert: '⚠️ IMPORTANTE: Si en algún momento lo contactan para pedirle dinero por la liberación de su ser querido, no haga nada más y llame INMEDIATAMENTE a la línea 165 del GAULA.', 
                type: 'single-choice', 
                options: [
                    { id: '4.2.1', label: 'Narcotráfico o crimen organizado' },
                    { id: '4.2.2', label: 'Trata de personas o explotación sexual' },
                    { id: '4.2.3', label: 'Violencia intrafamiliar o de pareja' },
                    { id: '4.2.4', label: 'Secuestro' },
                    { id: '4.2.5', label: 'Extorsión', help: 'Lo han llamado para cobrarle dinero por el rescate o información.' },
                    { id: '4.2.6', label: 'Otro tipo de crimen / No sé específicamente' }
                ]
            },
            // SUB-PANTALLA MIGRACIÓN (4.5)
            'p1_migration': { 
                progress: '95%', 
                title: 'Detalle migratorio', 
                type: 'single-choice', 
                options: [
                    { id: '4.5.1', label: 'Planeaba migrar y desapareció en el camino' },
                    { id: '4.5.2', label: 'Ya estaba en otro país y perdimos contacto' },
                    { id: '4.5.3', label: 'Fue forzada a salir del país (posible trata)' },
                    { id: '4.5.4', label: 'Otra situación' }
                ]
            },
            
            'p_narrative': {
                progress: '98%',
                title: 'Detalles Adicionales (Opcional)',
                description: 'Escriba brevemente: ¿Cómo vestía? ¿Tenía señales particulares?', 
                type: 'textarea',
                next: 'results'
            },

            'results': { progress: '100%', title: 'Ruta de Acción', type: 'results' }
        };

        // --- 4. CARGA DE DATOS ---
        async function loadData() {
            const status = document.getElementById('loaderStatus');
            const errorMsg = document.getElementById('errorMsg');
            
            try {
                const loadSheet = async (url) => {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
                    const text = await res.text();
                    return Papa.parse(text, { 
                        header: true, 
                        skipEmptyLines: true,
                        transformHeader: h => h.trim() // IMPORTANTE: Limpia espacios en nombres de columnas
                    }).data;
                };

                status.innerText = "Descargando Directorio...";
                DB_CONTACTOS = await loadSheet(SHEETS_CONFIG.CONTACTOS);

                // --- PROCESAMIENTO LISTAS DINÁMICAS ---
                // Helper para obtener únicos, ordenar y agregar 'Otro'
                const getUniqueSorted = (data, key) => {
                    const unique = [...new Set(data.map(item => item[key]?.trim()).filter(Boolean))].sort();
                    if (!unique.includes('Otro')) unique.push('Otro');
                    return unique;
                };

                COUNTRIES_LIST = getUniqueSorted(DB_CONTACTOS, 'PAIS');
                CITIES_LIST = getUniqueSorted(DB_CONTACTOS, 'CIUDAD');
                MUNICIPALITIES_LIST = getUniqueSorted(DB_CONTACTOS, 'MUNICIPIO');

                // Actualizar configuración de pasos con datos reales
                steps['p3.1'].data = CITIES_LIST;
                steps['p3.2'].municipalityData = MUNICIPALITIES_LIST;
                steps['p3.2'].cityData = CITIES_LIST;
                steps['p3.3'].data = COUNTRIES_LIST;

                status.innerText = "Descargando Matriz de Acciones...";
                const accionesRaw = await loadSheet(SHEETS_CONFIG.ACCIONES);
                
                DB_ACCIONES = accionesRaw.map(row => ({
                    id: row.ID_ACCION ? row.ID_ACCION.trim() : '',
                    categoria: row.CATEGORIA ? row.CATEGORIA.trim().toUpperCase() : '',
                    // Aseguramos mayúsculas y limpieza en CASO y UBICACION
                    caso: row.CASO ? row.CASO.split(',').map(s => s.trim()) : [],
                    ubicacion: row.PERFIL_UBICACION ? row.PERFIL_UBICACION.split(',').map(s => s.trim()) : [],
                    temporalidad: row.LOGICA_TEMPORAL ? row.LOGICA_TEMPORAL.split(',').map(s => s.trim().toUpperCase()) : [],
                    etapa: parseInt(row.ETAPA) || 99,
                    prioridad: parseInt(row.PRIORIDAD) || 0,
                    titulo: row.TITULO_VISIBLE || "Acción",
                    contenido: row.CONTENIDO_MD || "",
                    contactos: row.CONTACTOS ? row.CONTACTOS.split(',') : []
                })).filter(a => a.id); // Filtrar filas vacías

                console.log("DB Cargada y Procesada:", { Acciones: DB_ACCIONES.length, Contactos: DB_CONTACTOS.length, Countries: COUNTRIES_LIST.length });
                document.getElementById('loader').style.display = 'none';
                renderView('intro');

            } catch (e) {
                console.error(e);
                status.innerText = "Error de conexión";
                status.classList.add("text-red-600", "font-bold");
                errorMsg.classList.remove('hidden');
                errorMsg.innerHTML = `<strong>Error al cargar datos.</strong><br>Verifique su conexión a internet.`;
            }
        }

        // --- NUEVA FUNCIÓN: CARGAR RUTA ESPECÍFICA ---
        async function loadRouteData() {
            const loader = document.getElementById('loader');
            const status = document.getElementById('loaderStatus');
            loader.style.display = 'flex';
            status.innerText = "Calculando Ruta Maestra...";

            const routeId = state.answers.p1;
            const url = ROUTES_MAP[routeId];

            if (!url) {
                CURRENT_ROUTE_DATA = [];
                loader.style.display = 'none';
                return;
            }

            try {
                const res = await fetch(url);
                const text = await res.text();
                const data = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
                // Normalizar datos de ruta
                CURRENT_ROUTE_DATA = data.map(row => ({
                    paso: row.PASO ? row.PASO.trim() : '',
                    titulo: row.TITULO || '',
                    descripcion: row.DESCRIPCION || '',
                    contenido: row.CONTENIDO_MD || ''
                }));
            } catch (e) {
                console.error("Error cargando ruta:", e);
                CURRENT_ROUTE_DATA = [];
            } finally {
                loader.style.display = 'none';
            }
        }

        // --- 5. RENDERIZADO UI ---
        function renderView(stepId) {
            state.currentStep = stepId;
            const config = steps[stepId];
            const container = document.getElementById('viewContainer');
            const progressContainer = document.getElementById('progressContainer');
            
            if (stepId === 'intro') {
                progressContainer.classList.add('opacity-0');
            } else {
                progressContainer.classList.remove('opacity-0');
                document.getElementById('progressBar').style.width = config.progress;
            }
            
            const nextBtn = document.getElementById('nextBtn');
            const backBtn = document.getElementById('backBtn');
            
            if (stepId === 'intro' || stepId === 'results') {
                document.getElementById('navButtons').classList.add('hidden');
            } else {
                document.getElementById('navButtons').classList.remove('hidden');
                backBtn.classList.toggle('invisible', stepId === 'p4');
                nextBtn.classList.add('hidden');
            }

            let html = '';

            if (config.type === 'intro') {
                html += `
                    <div class="text-center py-6">
                        <div class="bg-blue-50 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6 border border-blue-100">
                            <svg class="w-12 h-12 text-gov-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h2 class="text-3xl font-bold text-gov-blue mb-4">${config.title}</h2>
                        <p class="text-gray-600 text-lg mb-8 leading-relaxed max-w-2xl mx-auto">${config.description}</p>
                        <div class="bg-gov-bg border border-blue-100 rounded-lg p-5 mb-8 text-sm text-gray-600 flex items-start text-left max-w-2xl mx-auto">
                            <svg class="w-6 h-6 mr-3 mt-0.5 text-gov-blue flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <div>
                                <span class="font-bold block text-gov-dark-blue mb-1">Protección de Datos</span>
                                ${config.disclaimer}
                            </div>
                        </div>
                        <button onclick="goNext()" class="bg-gov-blue text-white px-10 py-4 rounded-full font-bold text-lg shadow-lg hover:bg-gov-dark-blue transition-all transform hover:scale-105 flex items-center mx-auto">
                            ${config.btnLabel}
                            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </button>
                    </div>`;
            }
            else if (config.type === 'results') {
                html += generateResultsEngine();
                document.getElementById('navButtons').classList.add('hidden');
            }
            else {
                // Renderizado Genérico
                html += `<h2 class="text-2xl font-bold text-gov-blue mb-3">${config.title}</h2>
                    ${config.description ? `<p class="text-gray-600 mb-6 text-lg">${config.description}</p>` : ''}
                    ${config.alert ? `<div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 text-red-700 font-bold rounded-r">${config.alert}</div>` : ''}`;

                if (config.type === 'single-choice' || config.type === 'multi-choice') {
                    const isMulti = config.type === 'multi-choice';
                    if(isMulti) nextBtn.classList.remove('hidden');
                    const wrapperClass = isMulti ? 'grid md:grid-cols-2 gap-4 mb-6' : 'space-y-3';
                    
                    html += `<div class="${wrapperClass}">`;
                    config.options.forEach(opt => {
                        let isSelected = false;
                        if(isMulti) {
                            let collection = stepId === 'p3.4' ? state.answers.p3_characteristics : state.answers.p4_profile;
                            isSelected = collection.includes(opt.id);
                        }

                        if (!isMulti) {
                            html += `
                            <div class="mb-3"><div class="relative flex items-center">
                                <button onclick="handleChoice('${opt.id}')" class="btn-gov group !mb-0 pr-12">
                                    <span class="text-lg text-left">${opt.label}</span>
                                    <svg class="w-6 h-6 text-blue-200 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                                ${opt.help ? `<button onclick="event.stopPropagation(); toggleHelp('help-${opt.id}')" class="absolute right-4 text-gov-blue hover:text-gov-dark-blue p-2 z-10" title="Ver ayuda"><svg class="w-6 h-6 bg-white rounded-full border border-gov-blue text-gov-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>` : ''}
                            </div>
                            ${opt.help ? `<div id="help-${opt.id}" class="hidden mt-2 mx-4 text-sm text-gov-dark-blue bg-blue-50 p-3 rounded-b-lg border-x border-b border-blue-100">${opt.help}</div>` : ''}</div>`;
                        } else {
                            html += `
                            <div onclick="toggleMulti(this, '${opt.id}', '${stepId}')" class="checkbox-card ${isSelected ? 'selected' : ''} flex flex-col !items-start">
                                <div class="flex items-center w-full">
                                    <div class="checkbox-mark">${isSelected ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>' : ''}</div>
                                    <span class="text-gray-700 font-semibold flex-1">${opt.label}</span>
                                    ${opt.help ? `<button onclick="event.stopPropagation(); toggleHelp('help-${opt.id}')" class="ml-2 text-gov-blue hover:bg-blue-100 rounded-full p-1 transition-colors flex-shrink-0" title="Ver ayuda"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>` : ''}
                                </div>
                                ${opt.help ? `<div id="help-${opt.id}" class="hidden w-full mt-3 text-sm text-gov-dark-blue bg-blue-50 p-3 rounded border border-blue-100 text-left">${opt.help}</div>` : ''}
                            </div>`;
                        }
                    });
                    html += '</div>';
                }
                else if (config.type === 'dropdown' || config.type === 'municipality-city') {
                    nextBtn.classList.remove('hidden');
                    if (config.type === 'dropdown') {
                        html += `<div class="mb-6"><select id="selectInput" onchange="this.classList.remove('border-red-500', 'ring-2', 'ring-red-200')" class="w-full p-4 border border-gray-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-gov-blue"><option value="">Seleccione una opción...</option>${config.data.map(i => `<option value="${i}">${i}</option>`).join('')}</select></div>`;
                    } else {
                        html += `
                        <div class="space-y-6"><div><label class="block text-gray-700 font-bold mb-2 text-sm uppercase tracking-wide">Municipio</label><select id="municipalityInput" onchange="this.classList.remove('border-red-500', 'ring-2', 'ring-red-200')" class="w-full p-4 border border-gray-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-gov-blue">${config.municipalityData.map(i => `<option value="${i}">${i}</option>`).join('')}</select></div><div class="bg-blue-50 p-4 rounded border border-blue-100"><label class="block text-gov-blue font-bold mb-2 text-sm uppercase tracking-wide flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>Ciudad Principal más cercana</label><p class="text-xs text-gray-500 mb-2">Seleccione dónde le quedaría más fácil recibir atención presencial.</p><select id="cityInput" onchange="this.classList.remove('border-red-500', 'ring-2', 'ring-red-200')" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-gov-blue"><option value="">Seleccione...</option>${config.cityData.map(i => `<option value="${i}">${i}</option>`).join('')}</select></div></div>`;
                    }
                }
                else if (config.type === 'date-year-picker') {
                    nextBtn.classList.remove('hidden');
                    const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div><label class="block text-gray-700 font-bold mb-2 text-sm uppercase tracking-wide">Mes</label><select id="monthInput" class="w-full p-4 border border-gray-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-gov-blue appearance-none bg-white"><option value="">Seleccione...</option>${months.map(m => `<option value="${m}">${m}</option>`).join('')}</select></div><div><label class="block text-gray-700 font-bold mb-2 text-sm uppercase tracking-wide">Año (4 dígitos)</label><input type="number" id="yearInput" placeholder="Ej: 2020" min="1900" max="2025" class="w-full p-4 border border-gray-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-gov-blue" oninput="if(this.value.length > 4) this.value = this.value.slice(0,4);"></div></div><div id="dateError" class="text-red-600 font-bold hidden mb-4 bg-red-50 p-3 rounded border border-red-200 text-center">⚠️ Por favor ingrese un año válido entre 1900 y 2025 y seleccione el mes.</div>`;
                }
                else if (config.type === 'textarea') {
                    nextBtn.classList.remove('hidden');
                    html += `<textarea id="narrativeInput" class="w-full p-4 border border-gray-300 rounded-lg h-40 outline-none focus:border-gov-blue text-lg" placeholder="Ej: Vestía jean azul, camisa roja. Tiene una cicatriz en la ceja..."></textarea>`;
                }
            }
            container.innerHTML = html;
        }

        // --- 6. LOGICA DE NAVEGACIÓN ---
        function handleChoice(val) {
            const cur = state.currentStep;
            if (cur === 'p2') state.answers.p2 = val;
            if (cur === 'p2.4_conflict') state.answers.p2_sub = val;
            if (cur === 'p3_type') state.answers.p3_type = val;
            if (cur === 'p1') state.answers.p1 = val;
            if (['p1_conflict', 'p1_crime', 'p1_migration'].includes(cur)) state.answers.p1_sub = val;
            state.history.push(cur);
            let next = '';
            if (cur === 'p2') { if (val === '2.1') next = 'p3_type'; else next = 'p2_date'; }
            else if (cur === 'p3_type') { if(val === '3.1') next = 'p3.1'; else if(val === '3.2') next = 'p3.2'; else next = 'p3.3'; }
            else if (cur === 'p1') { if(val === '4.1') next = 'p1_conflict'; else if(val === '4.2') next = 'p1_crime'; else if(val === '4.5') next = 'p1_migration'; else next = 'p_narrative'; }
            else if (['p1_conflict', 'p1_crime', 'p1_migration'].includes(cur)) { next = 'p_narrative'; }
            renderView(next);
        }
        function toggleMulti(el, val, step) {
            el.classList.toggle('selected');
            el.querySelector('.checkbox-mark').innerHTML = el.classList.contains('selected') ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>' : '';
            let arr = step === 'p3.4' ? state.answers.p3_characteristics : state.answers.p4_profile;
            if(arr.includes(val)) arr.splice(arr.indexOf(val), 1); else arr.push(val);
        }
        async function goNext() {
            const cur = state.currentStep;
            const currentConfig = steps[cur];
            if (currentConfig && currentConfig.type === 'dropdown') {
                const select = document.getElementById('selectInput');
                if (!select.value) { select.classList.add('border-red-500', 'ring-2', 'ring-red-200'); select.focus(); return; }
                state.answers.p3_detail = select.value;
            }
            if (currentConfig && currentConfig.type === 'municipality-city') {
                const muniSelect = document.getElementById('municipalityInput');
                const citySelect = document.getElementById('cityInput');
                let valid = true;
                if (!muniSelect.value) { muniSelect.classList.add('border-red-500', 'ring-2', 'ring-red-200'); valid = false; }
                if (!citySelect.value) { citySelect.classList.add('border-red-500', 'ring-2', 'ring-red-200'); valid = false; }
                if (!valid) return;
                
                const muniVal = muniSelect.value;
                const cityVal = citySelect.value;

                // CAMBIO: Si el municipio es "Otro", se guarda vacío para no romper la lógica de búsqueda
                state.answers.p3_sub_detail = (muniVal === 'Otro') ? '' : muniVal;
                state.answers.p3_detail = (cityVal === 'Otro') ? 'Bogotá D.C.' : cityVal;
            }

            if (currentConfig && currentConfig.type === 'textarea') {
                state.answers.narrative = document.getElementById('narrativeInput').value;
            }
            
            if (cur === 'p2_date') {
                const month = document.getElementById('monthInput').value;
                const year = document.getElementById('yearInput').value;
                const yearNum = parseInt(year);
                if (!month || !year || year.length !== 4 || yearNum < 1900 || yearNum > 2025) { document.getElementById('dateError').classList.remove('hidden'); return; }
                state.answers.p2_date_month = month;
                state.answers.p2_date_year = year;
            }
            if (cur === 'p4' && state.answers.p4_profile.length === 0) state.answers.p4_profile.push('1.11');
            if (cur === 'p3.4' && state.answers.p3_characteristics.length === 0) state.answers.p3_characteristics.push('3.4.10');
            
            state.history.push(cur);
            let next = '';
            if (cur === 'intro') next = 'p4';
            else if (cur === 'p4') next = 'p2';
            else if (cur === 'p2_date') next = 'p3_type';
            else if (['p3.1', 'p3.2', 'p3.3'].includes(cur)) next = 'p3.4';
            else if (cur === 'p3.4') next = 'p1';
            else if (cur === 'p_narrative') next = 'results';

            // --- CARGAR RUTA SI VAMOS A RESULTADOS ---
            if (next === 'results') {
                await loadRouteData();
            }

            renderView(next);
        }
        function goBack() { if(state.history.length > 0) renderView(state.history.pop()); }

        // --- 7. EL MOTOR DE LÓGICA (ACTUALIZADO) ---
        function generateResultsEngine() {
            // 1. Contexto Temporal
            const isReciente = state.answers.p2 === '2.1';
            const temporalContext = isReciente ? 'URGENTE' : 'HISTORICO';

            // 2. Contexto Fecha Conflicto
            let conflictDateContext = null;
            if (!isReciente && (state.answers.p1 === '4.1' || state.answers.p1_sub?.startsWith('4.1'))) {
                const year = parseInt(state.answers.p2_date_year);
                const monthName = state.answers.p2_date_month;
                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const monthIndex = months.indexOf(monthName);
                
                const dateCutoff = new Date(2016, 11, 1); 
                const dateUser = new Date(year, monthIndex, 1);
                
                conflictDateContext = (dateUser < dateCutoff) ? 'PRE_2016' : 'POST_2016';
            }

            // 3. Recolectar Tags del Usuario
            const userTags = new Set();
            if (state.answers.p1) userTags.add(state.answers.p1);
            if (state.answers.p1_sub) userTags.add(state.answers.p1_sub);
            state.answers.p4_profile.forEach(t => userTags.add(t));
            state.answers.p3_characteristics.forEach(t => userTags.add(t));

            // 4. Filtrado Maestro Acciones
            let matchedActions = DB_ACCIONES.filter(action => {
                const casoMatch = action.caso.includes('TODOS') || action.caso.some(c => userTags.has(c));
                const ubiMatch = action.ubicacion.includes('TODOS') || action.ubicacion.some(u => userTags.has(u));
                if (!casoMatch || !ubiMatch) return false;
                const timeMatch = action.temporalidad.includes('AMBAS') || action.temporalidad.includes(temporalContext);
                if (!timeMatch) return false;
                if (conflictDateContext) {
                    if (conflictDateContext === 'PRE_2016' && action.temporalidad.includes('POST_2016') && !action.temporalidad.includes('PRE_2016')) return false;
                    if (conflictDateContext === 'POST_2016' && action.temporalidad.includes('PRE_2016') && !action.temporalidad.includes('POST_2016')) return false;
                }
                return true;
            });

            const uniqueMap = new Map();
            matchedActions.forEach(action => {
                if (!uniqueMap.has(action.id) || action.prioridad > uniqueMap.get(action.id).prioridad) {
                    uniqueMap.set(action.id, action);
                }
            });
            const finalActions = Array.from(uniqueMap.values());
            finalActions.sort((a, b) => a.etapa - b.etapa);

            // === CLASIFICACIÓN POR PESTAÑAS ===
            const legalActions = finalActions.filter(a => a.categoria === 'ACCION LEGAL');
            const ownActions = finalActions.filter(a => a.categoria === 'ACCION PROPIA');
            const supportActions = finalActions.filter(a => a.categoria === 'APOYO EXTRA');
            const narrative = state.answers.narrative || '';

            // --- RENDERIZADO ACCIONES ---
            const renderActionList = (actions, groupName = 'default') => {
                if (actions.length === 0) return '<div class="p-6 bg-gray-50 text-gray-500 rounded-lg text-center border border-gray-200">No hay acciones específicas para este criterio.</div>';
                return actions.map((action, idx) => {
                    let rawContent = action.contenido;
                    
                    // REEMPLAZO INFORMACIÓN ADICIONAL
                    if (rawContent.includes('&INFORMACION_ADICIONAL&')) {
                        const infoText = narrative ? `**${narrative}**` : '';
                        rawContent = rawContent.replace(/&INFORMACION_ADICIONAL&/g, infoText);
                    }

                    // LÓGICA DE REEMPLAZO DE CONTACTOS MEJORADA
                    if (rawContent.includes('&CONTACTO&')) {
                        const contactIds = action.contactos; 
                        
                        const contactDetails = contactIds.map(id => {
                            const cleanId = id.trim();
                            // Filtrar todos los candidatos con ese ID
                            const candidates = DB_CONTACTOS.filter(c => c.ID_ENTIDAD === cleanId);
                            if (candidates.length === 0) return '';

                            // Variables de contexto del usuario
                            const userMuni = state.answers.p3_sub_detail || ''; // Vacío si es 'Otro'
                            const userCity = state.answers.p3_detail || '';

                            let bestMatch = null;

                            // 1. Coincidencia exacta de Municipio (si el usuario eligió uno específico)
                            if (userMuni) {
                                bestMatch = candidates.find(c => c.MUNICIPIO === userMuni);
                            }

                            // 2. Coincidencia de Ciudad (si no hubo municipio exacto)
                            if (!bestMatch && userCity) {
                                bestMatch = candidates.find(c => c.CIUDAD === userCity);
                            }

                            // 3. Fallback Nacional (Colombia / Nacional / Municipio Vacio)
                            if (!bestMatch) {
                                bestMatch = candidates.find(c => 
                                    c.PAIS === 'Colombia' && 
                                    c.CIUDAD === 'Nacional' && 
                                    (!c.MUNICIPIO || c.MUNICIPIO.trim() === '')
                                );
                            }
                            
                            // 4. Fallback Bogotá (Colombia / Bogotá... / Municipio Vacio) - NUEVO
                            if (!bestMatch) {
                                bestMatch = candidates.find(c => 
                                    c.PAIS === 'Colombia' && 
                                    c.CIUDAD && c.CIUDAD.toLowerCase().startsWith('bogo') &&
                                    (!c.MUNICIPIO || c.MUNICIPIO.trim() === '')
                                );
                            }

                            if (!bestMatch) return ''; // Si no hay match ni default, no mostrar nada

                            const contactHtml = marked.parse(bestMatch.CONTENIDO_MD);
                            return `<div class="bg-blue-50 border-l-4 border-gov-blue p-4 my-3 rounded-r-lg shadow-sm text-sm">${contactHtml}</div>`;
                        }).join('');
                        
                        rawContent = rawContent.replace(/&CONTACTO&/g, contactDetails);
                    }

                    const htmlContent = marked.parse(rawContent);
                    return `
                    <details name="guide-accordion" class="group bg-white border border-gray-200 rounded-lg mb-3 shadow-sm hover:shadow-md transition-all">
                        <summary class="flex items-center p-4 cursor-pointer select-none">
                            <div class="flex items-center flex-1">
                                <span class="bg-blue-100 text-gov-blue text-xs px-2 py-1 rounded mr-3 font-extrabold border border-blue-200 min-w-[24px] text-center">${action.etapa}</span>
                                <span class="font-bold text-gov-dark-blue text-lg">${action.titulo}</span>
                            </div>
                            <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </summary>
                        <div class="p-5 pt-2 text-gray-700 leading-relaxed border-t border-gray-100 bg-gray-50 text-base md-content">
                            ${htmlContent}
                        </div>
                    </details>`;
                }).join('');
            };

            // --- RENDERIZADO RUTA MAESTRA (RECURSIVO) ---
            const renderRouteMaster = () => {
                if (!CURRENT_ROUTE_DATA || CURRENT_ROUTE_DATA.length === 0) {
                    return '<div class="p-6 bg-gray-50 text-gray-500 rounded-lg text-center border border-gray-200">Cargando ruta...</div>';
                }

                // 1. Preparar Nodos y Mapa de BIFs
                const nodes = CURRENT_ROUTE_DATA.map(row => ({
                    ...row,
                    cleanId: row.paso.replace('BIF', '').trim(),
                    isBif: row.paso.startsWith('BIF'),
                    children: []
                }));

                const bifMap = {};
                nodes.filter(n => n.isBif).forEach(n => {
                    bifMap[n.cleanId] = n;
                });

                // 2. Construir Árbol (Asignar cada nodo a su padre más específico)
                const root = [];
                nodes.forEach(node => {
                    if (node.paso === 'SEPARADOR') {
                        root.push(node);
                        return;
                    }

                    let bestParent = null;
                    let maxLen = 0;

                    // Buscar el padre más adecuado (BIF cuyo prefijo coincida con el inicio del ID del nodo)
                    Object.keys(bifMap).forEach(prefix => {
                        // El nodo debe empezar con el prefijo, NO ser el mismo BIF, y ser el match más largo encontrado
                        const isChild = node.cleanId.startsWith(prefix) && node.cleanId !== prefix;
                        
                        if (isChild && prefix.length > maxLen) {
                            // Verificación adicional para asegurar límites correctos (ej: "6.A" vs "6.A.1")
                            // Asumimos que la estructura es consistente con puntos o letras
                            maxLen = prefix.length;
                            bestParent = bifMap[prefix];
                        }
                    });

                    if (bestParent) {
                        bestParent.children.push(node);
                    } else {
                        root.push(node);
                    }
                });

                // 3. Renderizado Recursivo
                const renderRecursive = (nodeList, groupName = 'guide-accordion') => {
                    return nodeList.map(node => {
                        // Usar CONTENIDO_MD en lugar de DESCRIPCION para el separador
                        const mdContent = marked.parse(node.contenido || '');
                        
                        if (node.paso === 'SEPARADOR') {
                            return `
                            <div class="mt-8 mb-4 bg-gov-dark-blue text-white p-4 rounded-lg shadow-md">
                                <h4 class="font-bold text-lg">${node.titulo}</h4>
                                <div class="text-sm opacity-90 mt-1 md-content">${mdContent}</div>
                            </div>`;
                        }

                        if (node.isBif) {
                            // Render BIF (Padre Recursivo)
                            // CAMBIO: Asignar un grupo diferente a los hijos
                            const childrenHtml = renderRecursive(node.children, `guide-accordion-${node.cleanId}`);
                            return `
                            <details name="${groupName}" class="group bg-blue-50 border border-blue-200 rounded-lg mb-3 shadow-sm hover:shadow-md transition-all ml-0">
                                <summary class="flex items-center p-4 cursor-pointer select-none">
                                    <div class="flex items-center flex-1">
                                        <span class="bg-gov-dark-blue text-white text-xs px-2 py-1 rounded mr-3 font-extrabold border border-blue-900 min-w-[24px] text-center">Opc</span>
                                        <span class="font-bold text-gov-dark-blue text-lg">${node.titulo}</span>
                                    </div>
                                    <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </summary>
                                <div class="p-5 pt-2 text-gray-700 leading-relaxed border-t border-blue-100 bg-white text-base md-content">
                                    ${mdContent}
                                    ${childrenHtml ? `<div class="mt-4 pt-4 border-t border-gray-100 pl-4 border-l-2 border-blue-100 space-y-2">${childrenHtml}</div>` : ''}
                                </div>
                            </details>`;
                        } else {
                            // Render Paso (Hoja)
                            return `
                            <details name="${groupName}" class="group bg-white border border-gray-200 rounded-lg mb-2 shadow-sm hover:shadow-md transition-all">
                                <summary class="flex items-center p-4 cursor-pointer select-none">
                                    <div class="flex items-center flex-1">
                                        <span class="bg-blue-100 text-gov-blue text-xs px-2 py-1 rounded mr-3 font-extrabold border border-blue-200 min-w-[24px] text-center">${node.paso}</span>
                                        <span class="font-bold text-gov-dark-blue text-lg">${node.titulo}</span>
                                    </div>
                                    <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </summary>
                                <div class="p-5 pt-2 text-gray-700 leading-relaxed border-t border-gray-100 bg-gray-50 text-base md-content">
                                    ${mdContent}
                                </div>
                            </details>`;
                        }
                    }).join('');
                };

                return renderRecursive(root);
            };

            // HTML de Contactos
            let contactsHTML = '';
            if(DB_CONTACTOS.length > 0) {
                let localContacts = DB_CONTACTOS.filter(c => 
                    (c.Ciudad === state.answers.p3_detail || c.Cobertura === 'NACIONAL') && c.Activa === 'SI'
                );
                contactsHTML = localContacts.map(c => `
                    <li class="bg-white p-4 rounded border border-blue-100 shadow-sm mb-2">
                        <strong class="block text-gov-blue text-lg">${c.Nombre_Corto || c.Nombre_Largo}</strong>
                        <span class="block text-sm text-gray-700 mt-1">${c.Que_Hace_Resumen || ''}</span>
                        <div class="mt-2 text-sm text-gray-600">
                            📞 ${c.Telefono_Principal || c.Linea_Gratuita} <br>
                            📍 ${c.Direccion || 'Nacional'}
                        </div>
                    </li>`).join('');
                
                if(contactsHTML) contactsHTML = `<div class="mt-4 bg-blue-50 p-6 rounded-lg border border-blue-100"><ul class="space-y-0">${contactsHTML}</ul></div>`;
            }

            // const narrative = ... (eliminado por redundancia, ya tenemos state.answers.narrative)
            const lugarTexto = state.answers.p3_sub_detail ? `${state.answers.p3_sub_detail}` : (state.answers.p3_detail || 'la zona');
            // Ya no generamos scriptHTML aquí porque los guiones están integrados en las acciones

            // Contenidos Tabs
            const contentLegal = `<div class="space-y-2">${renderActionList(legalActions)}</div>`;
            const contentOwn = `<div class="space-y-2">${renderActionList(ownActions)}</div>`;
            // Apoyos: Acciones de Apoyo (sin titulo directorio)
            const contentSupport = `
                <div class="space-y-2 mb-8">${renderActionList(supportActions)}</div>
                ${contactsHTML}
            `;
            const contentMaster = `
                <div class="space-y-2">${renderRouteMaster()}</div>
            `;

            return `
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">Ruta de Acción Personalizada</h3>
                    <p class="text-gray-500">Guía de orientación generada automáticamente</p>
                </div>
                <div class="flex flex-wrap gap-2 mb-6">
                    <button id="btn-legal" onclick="switchTab('legal')" class="tab-btn active">Acciones Legales</button>
                    <button id="btn-propias" onclick="switchTab('propias')" class="tab-btn">Acciones Propias</button>
                    <button id="btn-apoyos" onclick="switchTab('apoyos')" class="tab-btn">Apoyos Extra</button>
                    <button id="btn-maestra" onclick="switchTab('maestra')" class="tab-btn">Ruta Completa de Búsqueda</button>
                </div>
                <div id="tab-legal" class="tab-content fade-in">${contentLegal}</div>
                <div id="tab-propias" class="tab-content hidden fade-in">${contentOwn}</div>
                <div id="tab-apoyos" class="tab-content hidden fade-in">${contentSupport}</div>
                <div id="tab-maestra" class="tab-content hidden fade-in">${contentMaster}</div>
                
                <div class="mt-12 text-center print:hidden">
                    <button onclick="window.print()" class="bg-white text-gov-blue border-2 border-gov-blue px-8 py-3 rounded-full font-bold hover:bg-blue-50 transition mr-4">Descargar Guía (PDF)</button>
                    <button onclick="location.reload()" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-full font-bold hover:bg-gray-300 transition">Nueva Consulta</button>
                </div>`;
        }

        function getProfiles() {
            const map = { '1.1': 'Menor de edad', '1.2': 'Líder/Rol Público', '1.3': 'Fuerza Pública', '1.4': 'Actor Armado', '1.5': 'Condición Especial/Mayor', '1.6': 'Migrante/Extranjero', '1.7': 'Mujer (Riesgo)', '1.8': 'Comunidad Étnica', '1.9': 'LGBTIQ+', '1.10': 'Desaparición Colectiva' };
            return state.answers.p4_profile.map(id => map[id] || id).join(', ') || "General";
        }

        loadData();
    </script>
</body>
</html>