<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía de Búsqueda - MinJusticia</title>
    <!-- Fuentes y Estilos -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'gov-blue': '#3366CC', 'gov-dark-blue': '#004884', 'gov-bg': '#F7F9FC' },
                    fontFamily: { sans: ['Nunito Sans', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Nunito Sans', sans-serif; background-color: #F2F2F2; color: #333; transition: background-color 0.3s, color 0.3s; }
        
        /* Botones Estilo GOV.CO */
        .btn-gov {
            background-color: white; color: #3366CC; border: 2px solid #3366CC; border-radius: 25px; 
            padding: 12px 24px; font-weight: 700; transition: all 0.2s; width: 100%; text-align: left; 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
            cursor: pointer;
        }
        .btn-gov:hover, .btn-gov.selected { background-color: #3366CC; color: white; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(51, 102, 204, 0.2); }
        /* Ajuste para que el texto de ayuda no cambie de color al hover del padre si no se quiere, 
           pero aquí permitiremos que se integre. */
        
        /* Checkbox Cards */
        .checkbox-card { 
            cursor: pointer; border: 1px solid #d1d5db; background: white; transition: all 0.2s; 
            border-radius: 8px; padding: 16px; display: flex; align-items: center;
        }
        .checkbox-card:hover { border-color: #3366CC; background-color: #F8FBFF; }
        .checkbox-card.selected { border-color: #3366CC; background-color: #EFF6FF; ring: 1px solid #3366CC; }
        
        /* flex-shrink-0 para evitar deformación */
        .checkbox-mark { 
            width: 20px; height: 20px; flex-shrink: 0; 
            border: 2px solid #9CA3AF; border-radius: 4px; margin-right: 12px; 
            display: flex; align-items: center; justify-content: center; background: white; 
        }
        .checkbox-card.selected .checkbox-mark { border-color: #3366CC; background-color: #3366CC; }
        
        /* Acordeones */
        details > summary { list-style: none; cursor: pointer; transition: all 0.3s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { background-color: #EFF6FF; border-bottom: 1px solid #E5E7EB; }
        .chevron { transition: transform 0.3s; }
        details[open] .chevron { transform: rotate(180deg); }
        
        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 50; display: flex; justify-content: center; align-items: center; flex-direction: column; }

        /* --- ACCESIBILIDAD --- */
        /* Menú Flotante */
        .a11y-menu {
            position: fixed; right: 0; top: 50%; transform: translateY(-50%); z-index: 60;
            display: flex; flex-direction: column; gap: 2px;
        }
        .a11y-btn {
            background-color: #004884; color: white; border: none; padding: 10px; width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: flex-start; 
            cursor: pointer;
            border-top-left-radius: 4px; border-bottom-left-radius: 4px;
            transition: width 0.3s ease, background-color 0.2s; overflow: hidden; white-space: nowrap;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.2);
        }
        /* Filtro para asegurar que los iconos sean blancos */
        .a11y-btn img {
            filter: brightness(0) invert(1); 
        }

        .a11y-btn:hover { width: 140px; background-color: #3366CC; }
        .a11y-label { opacity: 0; margin-left: 10px; font-size: 14px; font-weight: 600; transition: opacity 0.2s; }
        .a11y-btn:hover .a11y-label { opacity: 1; }

        /* Alto Contraste (Overrides) */
        body.high-contrast { background-color: #000 !important; color: #FFF !important; }
        body.high-contrast header { background-color: #000 !important; border-bottom: 2px solid #FFFF00; }
        body.high-contrast .bg-white { background-color: #000 !important; color: #FFF !important; border: 1px solid #FFF !important; }
        body.high-contrast .bg-blue-50, body.high-contrast .bg-gov-bg, body.high-contrast .bg-gray-100 { background-color: #1a1a1a !important; color: #FFF !important; border: 1px solid #888; }
        
        body.high-contrast .text-gov-blue, body.high-contrast .text-gov-dark-blue { color: #FFFF00 !important; }
        body.high-contrast .text-gray-600, body.high-contrast .text-gray-700, body.high-contrast .text-gray-500 { color: #DDD !important; }
        
        body.high-contrast .btn-gov { background-color: #000 !important; color: #FFFF00 !important; border-color: #FFFF00 !important; }
        body.high-contrast .btn-gov:hover, body.high-contrast .btn-gov.selected { background-color: #FFFF00 !important; color: #000 !important; }
        
        body.high-contrast .checkbox-card { background-color: #000 !important; border-color: #FFF !important; }
        body.high-contrast .checkbox-card.selected { border: 2px solid #FFFF00 !important; }
        body.high-contrast .checkbox-mark { background-color: #000 !important; border-color: #FFFF00 !important; }
        body.high-contrast .checkbox-card.selected .checkbox-mark { background-color: #FFFF00 !important; }
        body.high-contrast .checkbox-card.selected .checkbox-mark svg { color: #000 !important; }

        body.high-contrast footer { background-color: #111 !important; border-top: 1px solid #FFFF00; }
        body.high-contrast img { filter: grayscale(100%) contrast(120%); }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Menú de Accesibilidad -->
    <div class="a11y-menu">
        <button onclick="toggleContrast()" class="a11y-btn" aria-label="Alto Contraste">
            <img src="icons8-contrast-50.png" class="w-6 h-6 flex-shrink-0" alt="Contraste">
            <span class="a11y-label">Contraste</span>
        </button>
        <button onclick="changeFontSize(-10)" class="a11y-btn" aria-label="Reducir Letra">
            <img src="icons8-decrease-font-64.png" class="w-6 h-6 flex-shrink-0" alt="Reducir">
            <span class="a11y-label">Reducir Letra</span>
        </button>
        <button onclick="changeFontSize(10)" class="a11y-btn" aria-label="Aumentar Letra">
            <img src="icons8-increase-font-64.png" class="w-6 h-6 flex-shrink-0" alt="Aumentar">
            <span class="a11y-label">Aumentar Letra</span>
        </button>
    </div>

    <!-- Pantalla de Carga -->
    <div id="loader">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-gov-blue mb-4"></div>
        <p class="text-gov-blue font-bold text-lg">Cargando Guía Interactiva...</p>
        <p id="loaderStatus" class="text-sm text-gray-500 mt-2 font-mono">Conectando a Google Sheets...</p>
        <div id="errorMsg" class="hidden mt-4 text-center max-w-md p-4 bg-red-50 border border-red-200 rounded text-red-700 text-sm"></div>
    </div>

    <!-- Header -->
    <header class="bg-gov-blue text-white py-4 shadow-md sticky top-0 z-40 transition-colors duration-300">
        <div class="container mx-auto px-4 flex items-center">
            <a href="https://www.gov.co/" target="_blank" class="mr-4 border-r border-blue-400 pr-4 flex items-center hover:opacity-90 transition-opacity">
                <img src="logoGovCO.png" alt="GOV.CO" class="h-8 md:h-9 w-auto">
            </a>
            <div class="text-sm font-light leading-tight">Guía de Búsqueda de Personas<br><span class="font-bold">Ministerio de Justicia y del Derecho</span></div>
        </div>
    </header>

    <!-- Main -->
    <main class="container mx-auto px-4 py-8 max-w-4xl flex-grow">
        <!-- Barra de Progreso -->
        <div id="progressContainer" class="mb-8 max-w-3xl mx-auto transition-opacity duration-300">
            <div class="flex justify-between text-xs text-gray-500 mb-2 font-bold uppercase tracking-wider">
                <span>Perfil</span><span>Tiempo</span><span>Lugar</span><span>Indicios</span>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-gov-blue transition-all duration-500 ease-out" style="width: 10%"></div>
            </div>
        </div>

        <!-- Contenedor de Vistas -->
        <div id="viewContainer" class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 md:p-8 min-h-[400px] transition-colors duration-300">
            <!-- El contenido dinámico va aquí -->
        </div>

        <!-- Botones Navegación -->
        <div class="mt-8 flex justify-between max-w-3xl mx-auto" id="navButtons">
            <button onclick="goBack()" id="backBtn" class="text-gov-blue font-bold hover:underline flex items-center px-4 py-2 invisible">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> Atrás
            </button>
            <button id="nextBtn" onclick="goNext()" class="bg-gov-blue text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-gov-dark-blue hidden flex items-center transition-all">
                Continuar <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gov-blue py-4 mt-auto transition-colors duration-300">
        <div class="container mx-auto px-4">
            <div class="border-t border-blue-400/30 pt-4 flex items-center">
                <img src="logoGovCO.png" alt="GOV.CO" class="h-6 w-auto opacity-90 brightness-0 invert">
            </div>
        </div>
    </footer>

    <script>
        // --- LOGICA DE ACCESIBILIDAD ---
        let currentFontSize = 100;

        function toggleContrast() {
            document.body.classList.toggle('high-contrast');
        }

        function changeFontSize(amount) {
            currentFontSize += amount;
            // Limites: 80% min, 150% max
            if (currentFontSize < 80) currentFontSize = 80;
            if (currentFontSize > 150) currentFontSize = 150;
            document.documentElement.style.fontSize = currentFontSize + '%';
        }

        function toggleHelp(helpId) {
            const helpEl = document.getElementById(helpId);
            if (helpEl) {
                helpEl.classList.toggle('hidden');
            }
        }

        // --- 1. CONFIGURACIÓN DE DATOS (MÉTODO GVIZ) ---
        const SHEET_ID = '13Cgrx89VqcTnLDLkxQjSS3ETKSjYLXFTiD3EdAt1FUk';
        
        // GIDs Configurados
        const GIDS = {
            ACCIONES: '885518893',  // CATALOGO DE ACCIONES
            REGLAS: '1063279104',   // REGLAS
            CONTACTOS: '150812843'  // CONTACTOS
        };

        // URLs usando GVIZ
        const SHEETS_CONFIG = {
            ACCIONES: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GIDS.ACCIONES}`,
            REGLAS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GIDS.REGLAS}`,
            CONTACTOS: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GIDS.CONTACTOS}`
        };

        // Bases de Datos en Memoria
        let DB_ACCIONES = {}; // Mapa: ID -> Objeto Acción
        let DB_REGLAS = {};   // Mapa: Trigger -> Array [Acciones]
        let DB_CONTACTOS = []; // Array de Contactos

        // --- 2. ESTADO DE LA APP ---
        const state = {
            currentStep: 'intro', // CAMBIO: INICIO EN INTRO
            history: [],
            answers: {
                p1: null, p1_sub: null, // Contexto (Indicios)
                p2: null, p2_sub: null, 
                p2_date_month: null, p2_date_year: null, // Fechas
                p3_type: null, p3_detail: null, p3_sub_detail: null, p3_characteristics: [], // Lugar
                p4_profile: [] // Perfil
            }
        };

        // CONSTANTES GEOGRÁFICAS
        const CITIES_LIST = ['Bogotá D.C.', 'Medellín', 'Cali', 'Barranquilla', 'Bucaramanga', 'Otro'];
        
        // --- 3. DEFINICIÓN DE PASOS (UI) ---
        const steps = {
            // PASO 0: INTRODUCCIÓN
            'intro': {
                progress: '0%',
                title: 'Bienvenido',
                type: 'intro',
                description: 'Esta es una herramienta de orientación para la búsqueda de personas dadas por desaparecidas. Le guiaremos paso a paso para identificar la ruta de acción más efectiva según su caso.',
                disclaimer: 'Su privacidad es fundamental. Esta guía es anónima: no almacenamos, registramos ni compartimos ningún dato personal que ingrese durante la consulta.',
                btnLabel: 'Comenzar Consulta'
            },
            // PASO 1: PERFIL (P4)
            'p4': { 
                progress: '20%', 
                title: '¿Quién es la persona desaparecida?', 
                description: 'Seleccione todas las condiciones que apliquen. Esto define la prioridad de la búsqueda.',
                type: 'multi-choice', 
                options: [
                    { id: '1.1', label: 'Es un/a niño/a o adolescente', help: 'Menor de 18 años al momento de desaparecer.' },
                    { id: '1.2', label: 'Es una persona con un rol público o de alto riesgo', help: 'Líder, defensor/a, periodista, sindicalista, político.' },
                    { id: '1.3', label: 'Es o fue miembro de la Fuerza Pública', help: 'Ejército, Policía, Armada, Fuerza Aérea, etc.' },
                    { id: '1.4', label: 'Es o fue integrante de un grupo armado ilegal', help: 'Guerrilla, AUC, BACRIM, GAO, etc.' },
                    { id: '1.5', label: 'Es una persona que requiere cuidado o apoyo especial', help: 'Adulto mayor, condiciones de salud mental, discapacidad.' },
                    { id: '1.6', label: 'Es migrante o de nacionalidad extranjera' },
                    { id: '1.7', label: 'Es una mujer y se teme violencia de género', help: 'Antecedentes de violencia intrafamiliar, exparejas agresivas, etc.' },
                    { id: '1.8', label: 'Pertenece a comunidad indígena o NARP', help: 'Comunidades Negras, Afrocolombianas, Raizales y Palenqueras.' },
                    { id: '1.9', label: 'Se identifica como persona LGBTIQ+' },
                    { id: '1.10', label: 'Desaparecieron dos o más personas juntas', help: 'Ej: madre e hijo, hermanos, familia entera.' },
                    { id: '1.11', label: 'Ninguna de las anteriores' }
                ]
            },
            // PASO 2: TIEMPO (P2)
            'p2': { 
                progress: '40%', 
                title: '¿Hace cuánto tiempo ocurrió?', 
                description: 'Esto determina si la búsqueda es operativa (urgente) o investigativa (histórica).',
                type: 'single-choice', 
                options: [
                    { id: '2.1', label: 'Ocurrió hace poco (horas, días o semanas)' },
                    { id: '2.2', label: 'Ocurrió hace más de un año' }
                ]
            },
            // PASO 2.1: FECHA DETALLADA (Solo si es > 1 año)
            'p2_date': {
                progress: '45%',
                title: 'Fecha aproximada de los hechos',
                description: 'Por favor indique el mes y año aproximado en que ocurrió la desaparición.',
                type: 'date-year-picker'
            },
            // PASO 3: LUGAR (P3)
            'p3_type': { 
                progress: '60%', 
                title: '¿Dónde ocurrió o fue vista por última vez?', 
                type: 'single-choice', 
                options: [
                    { id: '3.1', label: 'Capital o ciudad principal' },
                    { id: '3.2', label: 'Municipio pequeño o zona rural' },
                    { id: '3.3', label: 'En otro país' }
                ]
            },
            'p3.1': { progress: '65%', title: 'Seleccione la ciudad', type: 'dropdown', data: CITIES_LIST },
            
            // CAMBIO: NUEVO TIPO PARA MUNICIPIO + CIUDAD
            'p3.2': { 
                progress: '65%', 
                title: 'Ubicación en Municipio', 
                type: 'municipality-city', 
                municipalityData: ['Otro'], // Según instrucciones
                cityData: CITIES_LIST, // Para sugerir la ciudad cercana
                description: 'Seleccione el municipio y la ciudad principal más cercana para ubicar las entidades de apoyo.' 
            },
            
            'p3.3': { progress: '65%', title: 'Seleccione el país', type: 'dropdown', data: ['España', 'Estados Unidos', 'México', 'Ecuador', 'Chile', 'Otro'] },
            
            'p3.4': { 
                progress: '75%', 
                title: 'Características del lugar', 
                description: 'Marque si el lugar tiene alguna condición especial.',
                type: 'multi-choice', 
                options: [
                    { id: '3.4.1', label: 'En el agua o cerca de ella', help: 'Mar, río, costa, puerto, represa' },
                    { id: '3.4.2', label: 'Cerca de una frontera con otro país', help: 'Límite con Venezuela, Ecuador, Panamá, etc.' },
                    { id: '3.4.3', label: 'En un resguardo o territorio indígena', help: 'Territorio de un cabildo, comunidad o pueblo indígena' },
                    { id: '3.4.4', label: 'En un Parque Nacional o reserva natural', help: 'Parque Tayrona, El Cocuy, reserva forestal, etc.' },
                    { id: '3.4.5', label: 'En una montaña, selva o bosque (fuera de un parque)', help: 'Zona rural de difícil acceso, senderismo' },
                    { id: '3.4.6', label: 'En una zona de minería, petróleo u otra explotación de recursos', help: 'Cerca de una mina, un campo petrolero, zona de tala' },
                    { id: '3.4.7', label: 'En una zona de conflicto armado o con grupos ilegales', help: 'Presencia de guerrilla, paramilitares, bandas criminales' },
                    { id: '3.4.8', label: 'Dentro o cerca de una base militar, de policía o entidad del Estado', help: 'Batallón, estación de policía, CAI, instalaciones oficiales' },
                    { id: '3.4.9', label: 'Dentro o cerca de un cementerio o morgue', help: 'Fosas comunes, osarios, depósitos de cuerpos no identificados, fosa clandestina o enterramiento ilegal' },
                    { id: '3.4.10', label: 'Ninguna de estas' }
                ]
            },
            // PASO 4: CONTEXTO / INDICIOS (P1 - Flujo Inverso)
            'p1': { 
                progress: '90%', 
                title: '¿Tiene alguna sospecha de lo que ocurrió?', 
                description: 'Esta información nos ayuda a dirigirlo a la entidad especializada.',
                type: 'single-choice', 
                options: [
                    { id: '4.1', label: 'En un contexto de conflicto armado o violencia política', help: 'Sospecha de Guerrilla, Paramilitares, "Falsos Positivos", Grupos Armados, violencia en protestas, muerto en combate.' },
                    { id: '4.2', label: 'A causa de un crimen o acto de delincuencia común', help: 'Sospecha de secuestro, extorsión, robo, "gota a gota", bandas, trata de personas, violencia de pareja.' },
                    { id: '4.3', label: 'Se perdió o se ausentó (sin violencia aparente)', help: 'Salió de casa y no regresó, puede estar desorientado/a, se fue por voluntad propia, se perdió en un lugar concurrido.' },
                    { id: '4.4', label: 'Durante un accidente o desastre natural', help: 'Desapareció en un río, en el mar, en una montaña (senderismo) o durante una avalancha, derrumbe, etc.' },
                    { id: '4.5', label: 'En un contexto de migración o estando en el exterior', help: 'Estaba en una ruta migratoria (ej. Darién) o vivía/viajaba en otro país.' },
                    { id: '4.6', label: 'No tengo sospechas claras de lo que pudo pasar', help: 'Simplemente no he vuelto a saber de él/ella y no tengo pistas para empezar.' }
                ]
            },
            // SUB-PANTALLA CONFLICTO (4.1)
            'p1_conflict': { 
                progress: '95%', 
                title: 'Detalles del Conflicto', 
                description: 'Especifique la situación para activar rutas de búsqueda humanitaria.',
                type: 'single-choice', 
                options: [
                    { id: '4.1.1', label: 'Involucra grupos armados al margen de la ley', help: 'Guerrilla, BACRIM, disidencias, grupos multicrimen.' },
                    { id: '4.1.2', label: 'Sospecha de participación de agentes del Estado', help: 'Policía, Ejército o Servidores Públicos.' },
                    { id: '4.1.3', label: 'Relacionado con reclutamiento forzado de menores' },
                    { id: '4.1.4', label: 'Muerto en combate o acto de hostilidades' },
                    { id: '4.1.5', label: 'Otra situación / No sé específicamente' }
                ]
            },
            // SUB-PANTALLA CRIMEN (4.2)
            'p1_crime': { 
                progress: '95%', 
                title: 'Especifique el tipo de crimen', 
                alert: '⚠️ IMPORTANTE: Si en algún momento lo contactan para pedirle dinero por la liberación de su ser querido, no haga nada más y llame INMEDIATAMENTE a la línea 165 del GAULA.', 
                type: 'single-choice', 
                options: [
                    { id: '4.2.1', label: 'Narcotráfico o crimen organizado' },
                    { id: '4.2.2', label: 'Trata de personas o explotación sexual' },
                    { id: '4.2.3', label: 'Violencia intrafamiliar o de pareja' },
                    { id: '4.2.4', label: 'Secuestro' },
                    { id: '4.2.5', label: 'Extorsión', help: 'Lo han llamado para cobrarle dinero por el rescate o información.' },
                    { id: '4.2.6', label: 'Otro tipo de crimen / No sé específicamente' }
                ]
            },
            // SUB-PANTALLA MIGRACIÓN (4.5)
            'p1_migration': { 
                progress: '95%', 
                title: 'Detalle migratorio', 
                type: 'single-choice', 
                options: [
                    { id: '4.5.1', label: 'Planeaba migrar y desapareció en el camino' },
                    { id: '4.5.2', label: 'Ya estaba en otro país y perdimos contacto' },
                    { id: '4.5.3', label: 'Fue forzada a salir del país (posible trata)' },
                    { id: '4.5.4', label: 'Otra situación' }
                ]
            },
            
            'p_narrative': {
                progress: '98%',
                title: 'Detalles Adicionales (Opcional)',
                description: 'Escriba brevemente: ¿Cómo vestía? ¿Tenía señales particulares?', // CAMBIO: Texto reducido
                type: 'textarea',
                next: 'results'
            },

            'results': { progress: '100%', title: 'Ruta de Acción', type: 'results' }
        };

        // --- 4. CARGA DE DATOS ---
        async function loadData() {
            const status = document.getElementById('loaderStatus');
            const errorMsg = document.getElementById('errorMsg');
            
            try {
                // Función helper para cargar un CSV
                const loadSheet = async (url) => {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
                    const text = await res.text();
                    return Papa.parse(text, { header: true, skipEmptyLines: true }).data;
                };

                // 1. Cargar Acciones
                status.innerText = "Descargando Catálogo de Acciones...";
                const accionesRaw = await loadSheet(SHEETS_CONFIG.ACCIONES);
                accionesRaw.forEach(row => {
                    if (row.ID_ACCION) {
                        DB_ACCIONES[row.ID_ACCION.trim()] = {
                            grupo: row.GRUPO_ID ? row.GRUPO_ID.trim() : null,
                            prioridad: parseInt(row.PRIORIDAD) || 0,
                            fase: parseInt(row.FASE) || 99,
                            titulo: row.TITULO || "Acción",
                            txt: {
                                '2.1': row.TXT_2_1,
                                '2.2': row.TXT_2_2,
                                '2.3': row.TXT_2_3,
                                '2.4': row.TXT_2_4,
                                '2.4.1': row.TXT_2_4_1,
                                '2.4.2': row.TXT_2_4_2
                            }
                        };
                    }
                });

                // 2. Cargar Reglas
                status.innerText = "Descargando Reglas...";
                const reglasRaw = await loadSheet(SHEETS_CONFIG.REGLAS);
                reglasRaw.forEach(row => {
                    if (row.ID_TRIGGER) {
                        const trigger = row.ID_TRIGGER.trim();
                        const actions = row.ACCIONES_ACTIVAR ? row.ACCIONES_ACTIVAR.split(',').map(s => s.trim()) : [];
                        DB_REGLAS[trigger] = actions;
                    }
                });

                // 3. Cargar Contactos
                status.innerText = "Descargando Directorio...";
                DB_CONTACTOS = await loadSheet(SHEETS_CONFIG.CONTACTOS);

                console.log("DB Cargada", { 
                    Acciones: Object.keys(DB_ACCIONES).length, 
                    Reglas: Object.keys(DB_REGLAS).length, 
                    Contactos: DB_CONTACTOS.length 
                });
                
                document.getElementById('loader').style.display = 'none';
                renderView('intro'); // Renderizar Intro en lugar de p4 directamente

            } catch (e) {
                console.error(e);
                status.innerText = "Error de conexión";
                status.classList.add("text-red-600", "font-bold");
                errorMsg.classList.remove('hidden');
                errorMsg.innerHTML = `<strong>No se pudo acceder a la Base de Datos.</strong><br><br>
                1. Ve a tu Google Sheet.<br>
                2. Clic en "Compartir" (Share).<br>
                3. Asegúrate que esté en <strong>"Cualquiera con el enlace"</strong> (Anyone with the link).`;
            }
        }

        // --- 5. RENDERIZADO UI ---
        function renderView(stepId) {
            state.currentStep = stepId;
            const config = steps[stepId];
            const container = document.getElementById('viewContainer');
            const progressContainer = document.getElementById('progressContainer');
            
            // Manejo de la Barra de Progreso
            if (stepId === 'intro') {
                progressContainer.classList.add('opacity-0');
            } else {
                progressContainer.classList.remove('opacity-0');
                document.getElementById('progressBar').style.width = config.progress;
            }
            
            const nextBtn = document.getElementById('nextBtn');
            const backBtn = document.getElementById('backBtn');
            
            // Ocultar controles de navegación en Intro
            if (stepId === 'intro' || stepId === 'results') {
                document.getElementById('navButtons').classList.add('hidden');
            } else {
                document.getElementById('navButtons').classList.remove('hidden');
                backBtn.classList.toggle('invisible', stepId === 'p4');
                nextBtn.classList.add('hidden');
            }

            let html = '';

            // VISTA INTRODUCCIÓN (NUEVO)
            if (config.type === 'intro') {
                html += `
                    <div class="text-center py-6">
                        <div class="bg-blue-50 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-6 border border-blue-100">
                            <svg class="w-12 h-12 text-gov-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h2 class="text-3xl font-bold text-gov-blue mb-4">${config.title}</h2>
                        <p class="text-gray-600 text-lg mb-8 leading-relaxed max-w-2xl mx-auto">${config.description}</p>
                        <div class="bg-gov-bg border border-blue-100 rounded-lg p-5 mb-8 text-sm text-gray-600 flex items-start text-left max-w-2xl mx-auto">
                            <svg class="w-6 h-6 mr-3 mt-0.5 text-gov-blue flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <div>
                                <span class="font-bold block text-gov-dark-blue mb-1">Protección de Datos</span>
                                ${config.disclaimer}
                            </div>
                        </div>
                        <button onclick="goNext()" class="bg-gov-blue text-white px-10 py-4 rounded-full font-bold text-lg shadow-lg hover:bg-gov-dark-blue transition-all transform hover:scale-105 flex items-center mx-auto">
                            ${config.btnLabel}
                            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </button>
                    </div>`;
            }
            else {
                // VISTAS ESTÁNDAR
                html += `
                    <h2 class="text-2xl font-bold text-gov-blue mb-3">${config.title}</h2>
                    ${config.description ? `<p class="text-gray-600 mb-6 text-lg">${config.description}</p>` : ''}
                    ${config.alert ? `<div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 text-red-700 font-bold rounded-r">${config.alert}</div>` : ''}
                `;

                if (config.type === 'single-choice') {
                    html += '<div class="space-y-3">';
                    config.options.forEach(opt => {
                        html += `
                        <div class="mb-3">
                            <div class="relative flex items-center">
                                <button onclick="handleChoice('${opt.id}')" class="btn-gov group !mb-0 pr-12">
                                    <span class="text-lg text-left">${opt.label}</span>
                                    <svg class="w-6 h-6 text-blue-200 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                                ${opt.help ? `
                                <button onclick="event.stopPropagation(); toggleHelp('help-${opt.id}')" class="absolute right-12 text-gov-blue hover:text-gov-dark-blue p-2 z-10" title="Ver ayuda">
                                    <svg class="w-6 h-6 bg-white rounded-full border border-gov-blue text-gov-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </button>
                                ` : ''}
                            </div>
                            ${opt.help ? `<div id="help-${opt.id}" class="hidden mt-2 mx-4 text-sm text-gov-dark-blue bg-blue-50 p-3 rounded-b-lg border-x border-b border-blue-100">${opt.help}</div>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                else if (config.type === 'multi-choice') {
                    nextBtn.classList.remove('hidden');
                    html += '<div class="grid md:grid-cols-2 gap-4 mb-6">';
                    config.options.forEach(opt => {
                        let collection = stepId === 'p3.4' ? state.answers.p3_characteristics : state.answers.p4_profile;
                        const isSelected = collection.includes(opt.id);
                        html += `
                        <div onclick="toggleMulti(this, '${opt.id}', '${stepId}')" class="checkbox-card ${isSelected ? 'selected' : ''} flex flex-col !items-start">
                            <div class="flex items-center w-full">
                                <div class="checkbox-mark">
                                    ${isSelected ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>' : ''}
                                </div>
                                <span class="text-gray-700 font-semibold flex-1">${opt.label}</span>
                                ${opt.help ? `
                                <button onclick="event.stopPropagation(); toggleHelp('help-${opt.id}')" class="ml-2 text-gov-blue hover:bg-blue-100 rounded-full p-1 transition-colors flex-shrink-0" title="Ver ayuda">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </button>` : ''}
                            </div>
                            ${opt.help ? `<div id="help-${opt.id}" class="hidden w-full mt-3 text-sm text-gov-dark-blue bg-blue-50 p-3 rounded border border-blue-100 text-left">${opt.help}</div>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                else if (config.type === 'dropdown') {
                    nextBtn.classList.remove('hidden');
                    // CAMBIO: onchange para remover el error visual cuando el usuario selecciona algo
                    html += `<div class="mb-6"><select id="selectInput" onchange="this.classList.remove('border-red-500', 'ring-2', 'ring-red-200')" class="w-full p-4 border border-gray-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-gov-blue"><option value="">Seleccione una opción...</option>${config.data.map(i => `<option value="${i}">${i}</option>`).join('')}</select></div>`;
                }
                // NUEVO TIPO: MUNICIPIO + CIUDAD (P3.2)
                else if (config.type === 'municipality-city') {
                    nextBtn.classList.remove('hidden');
                    html += `
                    <div class="space-y-6">
                        <div>
                            <label class="block text-gray-700 font-bold mb-2 text-sm uppercase tracking-wide">Municipio</label>
                            <select id="municipalityInput" onchange="this.classList.remove('border-red-500', 'ring-2', 'ring-red-200')" class="w-full p-4 border border-gray-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-gov-blue">
                                ${config.municipalityData.map(i => `<option value="${i}">${i}</option>`).join('')}
                            </select>
                        </div>
                        <div class="bg-blue-50 p-4 rounded border border-blue-100">
                            <label class="block text-gov-blue font-bold mb-2 text-sm uppercase tracking-wide flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
                                Ciudad Principal más cercana
                            </label>
                            <p class="text-xs text-gray-500 mb-2">Seleccione dónde le quedaría más fácil recibir atención presencial.</p>
                            <select id="cityInput" onchange="this.classList.remove('border-red-500', 'ring-2', 'ring-red-200')" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-gov-blue">
                                <option value="">Seleccione...</option>
                                ${config.cityData.map(i => `<option value="${i}">${i}</option>`).join('')}
                            </select>
                        </div>
                    </div>`;
                }
                // TIPO DE VISTA: DATE-YEAR-PICKER
                else if (config.type === 'date-year-picker') {
                    nextBtn.classList.remove('hidden');
                    const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    html += `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-gray-700 font-bold mb-2 text-sm uppercase tracking-wide">Mes</label>
                            <select id="monthInput" class="w-full p-4 border border-gray-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-gov-blue appearance-none bg-white">
                                <option value="">Seleccione...</option>
                                ${months.map(m => `<option value="${m}">${m}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-2 text-sm uppercase tracking-wide">Año (4 dígitos)</label>
                            <input type="number" id="yearInput" placeholder="Ej: 2020" min="1900" max="2025" 
                                class="w-full p-4 border border-gray-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-gov-blue"
                                oninput="if(this.value.length > 4) this.value = this.value.slice(0,4);">
                        </div>
                    </div>
                    <div id="dateError" class="text-red-600 font-bold hidden mb-4 bg-red-50 p-3 rounded border border-red-200 text-center">
                        ⚠️ Por favor ingrese un año válido entre 1900 y 2025 y seleccione el mes.
                    </div>
                    `;
                }
                else if (config.type === 'textarea') {
                    nextBtn.classList.remove('hidden');
                    html += `<textarea id="narrativeInput" class="w-full p-4 border border-gray-300 rounded-lg h-40 outline-none focus:border-gov-blue text-lg" placeholder="Ej: Vestía jean azul, camisa roja. Tiene una cicatriz en la ceja..."></textarea>`;
                }
                else if (config.type === 'results') {
                    html += generateResultsEngine(); 
                    document.getElementById('navButtons').classList.add('hidden');
                }
            }

            container.innerHTML = html;
        }

        // --- 6. LOGICA DE NAVEGACIÓN ---
        function handleChoice(val) {
            const cur = state.currentStep;
            
            // Guardar respuestas
            if (cur === 'p2') state.answers.p2 = val;
            if (cur === 'p2.4_conflict') state.answers.p2_sub = val; // Mantengo legacy por si acaso
            if (cur === 'p3_type') state.answers.p3_type = val;
            if (cur === 'p1') state.answers.p1 = val;
            if (['p1_conflict', 'p1_crime', 'p1_migration'].includes(cur)) state.answers.p1_sub = val;

            state.history.push(cur);

            // Router Lógica Inversa
            let next = '';
            
            if (cur === 'p2') {
                if (val === '2.1') next = 'p3_type'; // Reciente -> Lugar
                else next = 'p2_date'; // Antiguo -> Detalle Fecha
            }
            else if (cur === 'p3_type') {
                if(val === '3.1') next = 'p3.1'; else if(val === '3.2') next = 'p3.2'; else next = 'p3.3';
            }
            else if (cur === 'p1') {
                // Lógica de Indicios actualizada con los códigos 4.x
                if(val === '4.1') next = 'p1_conflict';
                else if(val === '4.2') next = 'p1_crime';
                else if(val === '4.5') next = 'p1_migration';
                else next = 'p_narrative'; // 4.3, 4.4, 4.6 van directo
            }
            else if (['p1_conflict', 'p1_crime', 'p1_migration'].includes(cur)) {
                next = 'p_narrative';
            }

            renderView(next);
        }

        function toggleMulti(el, val, step) {
            el.classList.toggle('selected');
            const mark = el.querySelector('.checkbox-mark');
            const isSelected = el.classList.contains('selected');
            mark.style.backgroundColor = isSelected ? '#3366CC' : 'white';
            mark.style.borderColor = isSelected ? '#3366CC' : '#9CA3AF';
            mark.innerHTML = isSelected ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>' : '';

            let arr = step === 'p3.4' ? state.answers.p3_characteristics : state.answers.p4_profile;
            if(arr.includes(val)) arr.splice(arr.indexOf(val), 1); else arr.push(val);
        }

        function goNext() {
            const cur = state.currentStep;
            const currentConfig = steps[cur];
            
            // --- CAMBIO: VALIDACIÓN DE DROPDOWNS (Punto 2) ---
            if (currentConfig && currentConfig.type === 'dropdown') {
                const select = document.getElementById('selectInput');
                if (!select.value) {
                    select.classList.add('border-red-500', 'ring-2', 'ring-red-200'); // Resaltar en rojo
                    select.focus();
                    return; // Detener avance
                }
                state.answers.p3_detail = select.value;
            }

            // --- CAMBIO: VALIDACIÓN MUNICIPIO/CIUDAD (Punto 2) ---
            if (currentConfig && currentConfig.type === 'municipality-city') {
                const muniSelect = document.getElementById('municipalityInput');
                const citySelect = document.getElementById('cityInput');
                let valid = true;

                if (!muniSelect.value) {
                    muniSelect.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                    valid = false;
                }
                if (!citySelect.value) {
                    citySelect.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                    valid = false;
                }
                
                if (!valid) return; // Detener si falta alguno

                state.answers.p3_sub_detail = muniSelect.value;
                state.answers.p3_detail = citySelect.value || muniSelect.value;
            }

            // Validación Fecha
            if (cur === 'p2_date') {
                const month = document.getElementById('monthInput').value;
                const year = document.getElementById('yearInput').value;
                const yearNum = parseInt(year);

                if (!month || !year || year.length !== 4 || yearNum < 1900 || yearNum > 2025) {
                    document.getElementById('dateError').classList.remove('hidden');
                    return; 
                }
                state.answers.p2_date_month = month;
                state.answers.p2_date_year = year;
            }

            // --- CAMBIO: LÓGICA POR DEFECTO PERFIL (Punto 1) ---
            if (cur === 'p4') {
                if (state.answers.p4_profile.length === 0) {
                    state.answers.p4_profile.push('1.11'); // 1.11 = Ninguna de las anteriores
                }
            }

            // --- CAMBIO: LÓGICA POR DEFECTO LUGAR (Punto 3) ---
            if (cur === 'p3.4') {
                if (state.answers.p3_characteristics.length === 0) {
                    state.answers.p3_characteristics.push('3.4.10'); // 3.4.10 = Ninguna de estas
                }
            }
            
            state.history.push(cur);
            let next = '';

            // NAVEGACIÓN SECUENCIAL
            if (cur === 'intro') next = 'p4'; // Intro -> Perfil
            else if (cur === 'p4') next = 'p2'; // Perfil -> Tiempo
            else if (cur === 'p2_date') next = 'p3_type'; // Fecha -> Lugar
            else if (['p3.1', 'p3.2', 'p3.3'].includes(cur)) next = 'p3.4'; // Detalles de lugar -> Características
            else if (cur === 'p3.4') next = 'p1'; // Características -> Indicios
            else if (cur === 'p_narrative') next = 'results'; // Narrativa -> Resultados

            renderView(next);
        }

        function goBack() {
            if(state.history.length > 0) renderView(state.history.pop());
        }

        // --- 7. EL MOTOR DE LÓGICA (ALGORITMO DE ABSORCIÓN) ---
        function generateResultsEngine() {
            // A. Recolectar Triggers (Contexto, Perfil, Lugar)
            const contextID = state.answers.p1_sub || state.answers.p1;
            const profileIDs = state.answers.p4_profile;
            const placeIDs = state.answers.p3_characteristics;
            const triggers = [contextID, ...profileIDs, ...placeIDs];

            // B. Recolectar Acciones Crudas desde REGLAS
            let rawActionIDs = [];
            triggers.forEach(t => {
                if (DB_REGLAS[t]) rawActionIDs.push(...DB_REGLAS[t]);
            });
            // Eliminar duplicados
            rawActionIDs = [...new Set(rawActionIDs)];

            // C. Competencia y Absorción (Lógica de Prioridad)
            let finalActions = [];
            let groupsSeen = {}; 

            rawActionIDs.forEach(id => {
                const actionData = DB_ACCIONES[id];
                if (!actionData) return;

                if (actionData.grupo) {
                    if (groupsSeen[actionData.grupo]) {
                        // Si ya existe una acción del grupo, gana la de mayor prioridad
                        if (actionData.prioridad > groupsSeen[actionData.grupo].prioridad) {
                            groupsSeen[actionData.grupo] = { id: id, prioridad: actionData.prioridad, data: actionData };
                        }
                    } else {
                        groupsSeen[actionData.grupo] = { id: id, prioridad: actionData.prioridad, data: actionData };
                    }
                } else {
                    finalActions.push(actionData);
                }
            });

            // Agregar los ganadores de los grupos
            Object.values(groupsSeen).forEach(item => finalActions.push(item.data));

            // D. Selección de Texto por Tiempo (Polimorfismo)
            let timeKey = state.answers.p2_sub || state.answers.p2; 
            
            // E. Ordenar por Fase (1: Vital, 2: Legal, 3: Búsqueda)
            finalActions.sort((a, b) => a.fase - b.fase);

            // F. Generar HTML de Pasos
            let htmlSteps = finalActions.map((action, idx) => {
                let displayText = action.txt[timeKey];
                
                // Fallback: Si no hay texto específico, busca en la acción base del grupo (Prioridad 0)
                if (!displayText && action.grupo) {
                    for (const key in DB_ACCIONES) {
                        const a = DB_ACCIONES[key];
                        if (a.grupo === action.grupo && a.prioridad === 0) {
                            displayText = a.txt[timeKey];
                            break;
                        }
                    }
                }
                
                if (!displayText) displayText = "Consulte a la autoridad competente.";

                return `
                <details class="group bg-white border border-gray-200 rounded-lg mb-3 shadow-sm hover:shadow-md transition-all">
                    <summary class="flex items-center p-4 cursor-pointer select-none">
                        <div class="flex items-center flex-1">
                            <span class="bg-blue-100 text-gov-blue text-xs px-2 py-1 rounded mr-3 font-extrabold border border-blue-200 min-w-[24px] text-center">${idx + 1}</span>
                            <span class="font-bold text-gov-dark-blue text-lg">${action.titulo}</span>
                        </div>
                        <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="p-5 pt-2 text-gray-700 leading-relaxed border-t border-gray-100 bg-gray-50 text-base">
                        ${displayText}
                    </div>
                </details>`;
            }).join('');

            // G. Contactos (Filtrado por Ciudad)
            let contactsHTML = '';
            let city = state.answers.p3_detail;
            
            if(DB_CONTACTOS.length > 0) {
                // Filtro: Ciudad seleccionada OR Nacional
                let localContacts = DB_CONTACTOS.filter(c => 
                    (c.Ciudad === city || c.Cobertura === 'NACIONAL') && c.Activa === 'SI'
                );
                
                let listItems = localContacts.map(c => `
                    <li class="bg-white p-4 rounded border border-blue-100 shadow-sm mb-2">
                        <strong class="block text-gov-blue text-lg">${c.Nombre_Corto || c.Nombre_Largo}</strong>
                        <span class="block text-sm text-gray-700 mt-1">${c.Que_Hace_Resumen || ''}</span>
                        <div class="mt-2 text-sm">
                            <div class="flex items-center text-gray-600 mb-1">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                <span>${c.Telefono_Principal || c.Linea_Gratuita}</span>
                            </div>
                            <div class="flex items-center text-gray-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                <span>${c.Direccion || 'Nacional'}</span>
                            </div>
                        </div>
                    </li>
                `).join('');

                if (listItems) {
                    contactsHTML = `
                        <div class="mt-8 bg-blue-50 p-6 rounded-lg border border-blue-100">
                            <h3 class="font-bold text-gov-dark-blue mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                                Directorio de Entidades (${city || 'Nacional'})
                            </h3>
                            <ul class="space-y-0">${listItems}</ul>
                        </div>
                    `;
                }
            }

            // H. Guion
            const narrative = document.getElementById('narrativeInput') ? document.getElementById('narrativeInput').value : '';
            const lugarTexto = state.answers.p3_sub_detail ? `${state.answers.p3_sub_detail} (Zona ${state.answers.p3_detail})` : (state.answers.p3_detail || 'la zona');
            
            const scriptHTML = narrative ? `
                <div class="bg-gray-100 p-6 rounded-lg mb-8 border-l-4 border-gray-500 shadow-sm print:border-black">
                    <h4 class="font-bold text-gray-700 text-xs uppercase mb-2 tracking-wider">Guion para su denuncia (Leer al funcionario)</h4>
                    <p class="text-gray-800 italic text-lg font-serif">"Vengo a reportar la desaparición de una persona con perfil: ${getProfiles()}. ${narrative}. Hechos ocurridos en ${lugarTexto} hace ${state.answers.p2}."</p>
                </div>
            ` : '';

            if (!htmlSteps) htmlSteps = '<div class="p-6 bg-yellow-50 text-yellow-800 rounded-lg text-center border border-yellow-200">No se encontraron acciones específicas para esta combinación. Por favor acuda directamente a la Fiscalía.</div>';

            return `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">Ruta de Acción Personalizada</h3>
                    <p class="text-gray-500">Guía de orientación generada automáticamente</p>
                </div>
                
                ${scriptHTML}

                <div class="space-y-2">
                    ${htmlSteps}
                </div>

                ${contactsHTML}

                <div class="mt-12 text-center print:hidden">
                    <button onclick="window.print()" class="bg-white text-gov-blue border-2 border-gov-blue px-8 py-3 rounded-full font-bold hover:bg-blue-50 transition mr-4">
                        Descargar Guía (PDF)
                    </button>
                    <button onclick="location.reload()" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-full font-bold hover:bg-gray-300 transition">
                        Nueva Consulta
                    </button>
                </div>
            `;
        }

        function getProfiles() {
            // Muestra nombres de perfiles seleccionados
            const map = {
                '1.1': 'Menor de edad', '1.2': 'Líder/Rol Público', '1.3': 'Fuerza Pública',
                '1.4': 'Actor Armado', '1.5': 'Condición Especial/Mayor', '1.6': 'Migrante/Extranjero',
                '1.7': 'Mujer (Riesgo)', '1.8': 'Comunidad Étnica', '1.9': 'LGBTIQ+',
                '1.10': 'Desaparición Colectiva'
            };
            return state.answers.p4_profile.map(id => map[id] || id).join(', ') || "General";
        }

        loadData();

    </script>
</body>
</html>